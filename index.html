<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="logo.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetHub</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.19/bundled/lenis.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Google Sans"', 'Roboto', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace'],
                    },
                    colors: {
                        googleBlue: '#1a73e8',
                        googleRed: '#ea4335',
                        googleYellow: '#fbbc04',
                        googleGreen: '#34a853',
                        darkSurface: '#303134',
                        darkBg: '#202124',
                        darkBorder: '#5f6368',
                        darkText: '#e8eaed',
                        darkTextSec: '#9aa0a6',
                        stockRed: '#f04a4a',
                        stockRedBg: '#fef1f1',
                        stockGreen: '#0fa968',
                        stockGreenBg: '#ecfdf5',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
            --input-hover: #f1f3f4;
            --input-focus-bg: #ffffff;
        }

        html.dark {
            --bg-body: #202124;
            --bg-card: #303134;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --input-hover: #3c4043;
            --input-focus-bg: #303134;
        }

        ::-webkit-scrollbar {
            width: 8px; 
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background-color: #dadce0; 
            border-radius: 10px; 
            border: 2px solid var(--bg-body); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #9aa0a6; 
        }
        html.dark ::-webkit-scrollbar-thumb {
            background-color: #5f6368;
            border-color: #202124; 
        }
        html.dark ::-webkit-scrollbar-thumb:hover {
            background-color: #9aa0a6;
        }

        .reveal-card {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), 
                        transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .reveal-card.active {
            opacity: 1;
            transform: translateY(0);
        }

        html { font-size: 19px; } 
        body { 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            transition: background-color 0.3s, color 0.3s;
        }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

       .g-card-static {
            background-color: var(--bg-card);
            border: none;
            border-radius: 0.5rem;
            box-shadow: none;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-google {
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: 1px solid transparent;
            transition: all 0.2s ease;
            color: var(--text-primary);
            padding: 2px 4px;
        }
        .input-google:hover { background-color: var(--input-hover); border-radius: 0.25rem; }
        .input-google:focus {
            background-color: var(--input-focus-bg);
            border: 1px solid #1a73e8;
            border-radius: 0.25rem;
            outline: none;
            box-shadow: 0 1px 2px rgba(26,115,232,0.1);
        }

        .btn-add, .btn-action {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .btn-add {
            color: #1a73e8;
            font-size: 0.75rem; 
            font-weight: 500;
            gap: 0.25rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
        }
        .btn-add:hover { background-color: rgba(26, 115, 232, 0.1); }

        .btn-action {
            font-size: 0.75rem;
            font-weight: 500;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            color: var(--text-secondary);
        }
        .btn-action:hover {
            background-color: var(--input-hover);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        .icon-glass { width: 1.2rem; height: 1.2rem; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        .pro-grid-header, .pro-grid-row {
            display: grid;
            grid-template-columns: 30px 1.2fr 1fr 1fr 1fr 1.5fr 2fr 0.8fr 40px;
            gap: 12px;
            align-items: center;
        }
        
        .cash-grid-header, .cash-grid-row {
            display: grid;
            grid-template-columns: 30px 1.4fr 1fr 1.3fr 0.8fr 40px;
            gap: 12px;
            align-items: center;
        }

        .drag-handle {
            cursor: grab;
            color: #dadce0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .drag-handle:active { cursor: grabbing; }
        html.dark .drag-handle { color: #5f6368; }
        .drag-handle:hover { color: #1a73e8; }

        #delete-popover { transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; }
        
        #sync-panel {
            /* 设定一个足够大的最大高度，让展开动画能平滑计算 */
            max-height: 500px; 
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out;
            overflow: hidden;
            transform-origin: top;
        }
        #sync-panel.hidden-panel {
            max-height: 0; 
            opacity: 0; 
            padding-top: 0; 
            padding-bottom: 0; 
            border: none; 
            margin-top: 0;
            margin-bottom: 0;
        }
        #sync-panel.hidden-panel {
            max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; border: none; margin: 0;
        }
    </style>
</head>
<body class="min-h-screen py-6 font-sans pb-16" onclick="handleBodyClick(event)">

    <div class="w-full px-[10px]">
        
        <header class="mb-6 flex justify-between items-center px-1">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-googleBlue border border-blue-100 dark:border-blue-800">
                    <svg class="icon-glass w-6 h-6" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                </div>
                <div><h1 class="text-xl font-normal text-textPrimary dark:text-darkText">AssetHub</h1></div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="btn-action" id="theme-btn" title="Toggle Theme">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>

                <button onclick="toggleSyncPanel()" class="btn-action" title="System Settings">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </button>

                <div class="flex gap-2 mr-2">
                    <button onclick="exportData()" class="btn-action" title="Export"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>Export</button>
                    <button onclick="document.getElementById('file-import').click()" class="btn-action" title="Import"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Import</button>
                    <input type="file" id="file-import" style="display: none;" accept=".json" onchange="importData(this)">
                </div>

                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-borderSubtle dark:border-darkBorder bg-white dark:bg-darkSurface shadow-sm transition-colors">
                    <svg onclick="fetchLiveRate()" class="w-3.5 h-3.5 text-textSecondary dark:text-darkTextSec cursor-pointer hover:text-googleBlue transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" title="Live Rate">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span class="text-xs font-medium text-textSecondary dark:text-darkTextSec whitespace-nowrap">FX Rate</span>
                    <input type="number" id="fx-rate" value="7.25" step="0.0001" class="w-16 text-right font-mono text-sm font-bold text-googleBlue bg-transparent focus:outline-none p-0 m-0 border-none appearance-none">
                </div>
            </div>
        </header>

        <div id="sync-panel" class="hidden-panel mb-6 p-5 g-card-static">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-googleBlue uppercase tracking-wide flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    System Settings
                </h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">GitHub Token</label>
                    <input type="password" id="gh-token" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="TOKEN">
                </div>
                <div>
                    <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">Repo</label>
                    <input type="text" id="gh-repo" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="user/repo">
                </div>
                <div>
                    <label class="text-[0.65rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider block mb-1">Data Path</label>
                    <input type="text" id="gh-path" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="data.json">
                </div>
                <div>
                    <label class="text-[0.65rem] font-bold text-googleBlue uppercase tracking-wider block mb-1">Finnhub Key</label>
                    <input type="password" id="finnhub-token" class="input-google w-full text-sm font-mono border-b border-borderSubtle dark:border-darkBorder focus:border-googleBlue" placeholder="KEY">
                </div>
            </div>
            <div class="flex gap-3 justify-end">
                <button onclick="saveSyncSettings()" class="btn-action hover:bg-gray-100 dark:hover:bg-gray-700">Save</button>
                <button onclick="pullFromGithub()" class="btn-action text-googleGreen border-googleGreen hover:bg-green-50 dark:hover:bg-green-900/20">Sync Data</button>
                <button onclick="pushToGithub()" class="btn-action text-white bg-googleBlue border-transparent hover:bg-blue-600 shadow-sm">Backup Data</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">

            <div class="lg:col-span-2 flex flex-col gap-4">
                <div class="g-card-static p-6 flex-shrink-0">
                    <div class="flex items-center gap-2 mb-1">
                        <p class="text-xs font-medium text-textSecondary dark:text-darkTextSec">Total Net Worth</p>
                        <button onclick="togglePrivacy()" class="text-textSecondary dark:text-darkTextSec hover:text-googleBlue focus:outline-none transition-colors" title="Toggle Privacy">
                            <svg id="eye-open" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            <svg id="eye-closed" class="w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
                        </button>
                    </div>
                    <h2 class="text-3xl lg:text-3xl font-bold text-textPrimary dark:text-darkText font-mono tracking-tight mb-2 truncate" id="total-nw-cny">¥0</h2>
                </div>

                <div class="g-card-static overflow-hidden flex-shrink-0">
                    <div class="p-4 border-b border-borderSubtle dark:border-darkBorder flex flex-col xl:flex-row xl:justify-between xl:items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <span class="text-sm text-textSecondary dark:text-darkTextSec">USD</span>
                        <div class="text-left xl:text-right">
                            <div class="text-2xl font-normal text-googleBlue font-mono" id="total-usd-assets">$0</div>
                            <div id="total-usd-cny-equiv" style="display: none;">≈ ¥0</div>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col xl:flex-row xl:justify-between xl:items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                        <span class="text-sm text-textSecondary dark:text-darkTextSec">CNY</span>
                        <div class="text-left xl:text-right">
                            <div class="text-2xl font-normal text-googleYellow font-mono" id="total-cny-assets">¥0</div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4 flex-1">
                    <div class="g-card-static p-4 flex flex-col flex-1">
                        <div class="w-full mb-2"><h3 class="text-[0.7rem] font-bold text-googleBlue uppercase tracking-wider">US Stocks</h3></div>
                        <div class="flex-1 flex flex-col xl:flex-row items-center justify-center gap-4">
                            <div class="h-24 w-24 relative flex-shrink-0"><canvas id="chart-us-sub"></canvas></div>
                            <div id="legend-us" class="space-y-1"></div>
                        </div>
                    </div>
                    <div class="g-card-static p-4 flex flex-col flex-1">
                        <div class="w-full mb-2"><h3 class="text-[0.7rem] font-bold text-googleYellow uppercase tracking-wider">CN Stocks</h3></div>
                        <div class="flex-1 flex flex-col xl:flex-row items-center justify-center gap-4">
                            <div class="h-24 w-24 relative flex-shrink-0"><canvas id="chart-cn-sub"></canvas></div>
                            <div id="legend-cn" class="space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="g-card-static p-6 relative flex-1 flex flex-col">
                    <div class="mb-4 text-left"><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">Asset Allocation</h2></div>
                    <div class="w-full flex-1 min-h-[21rem] relative flex items-center justify-center">
                        <canvas id="chart-main"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                       <span class="text-2xl font-bold text-textPrimary dark:text-darkText mt-1">AssetHub</span>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap justify-center gap-4 text-center px-2 flex-shrink-0">
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleBlue mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">US Stocks</p></div>
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleYellow mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">CN Stocks</p></div>
                        <div class="flex flex-col items-center"><span class="w-8 h-1 bg-googleGreen mb-1 rounded-full"></span><p class="text-xs font-bold text-textPrimary dark:text-darkText">Cash</p></div>
                    </div>
                </div>
                
                <div class="g-card-static p-6 flex-shrink-0">
                    <div class="flex justify-between items-center mb-4 border-b border-borderSubtle dark:border-darkBorder pb-2">
                        <h2 class="text-sm font-bold text-googleGreen uppercase tracking-wider">Liquidity</h2>
                        <span class="text-[0.65rem] bg-green-50 dark:bg-green-900/30 text-googleGreen px-2 py-1 rounded">>15%</span>
                    </div>
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-textSecondary dark:text-darkTextSec mb-1">Cash Ratio</p>
                                <div class="text-2xl font-bold text-googleGreen font-mono" id="cash-ratio">0%</div>
                            </div>
                            <div class="w-16 h-16 relative"><canvas id="chart-cash-sub"></canvas></div>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div id="cash-bar" class="bg-googleGreen h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6 flex flex-col gap-4">
                
                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="w-1 h-4 bg-googleBlue rounded-full"></div>
                            <h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">USD</h2>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="btn-add text-googleGreen" onclick="updateUsStockPrices()">
                                <svg id="refresh-icon" class="icon-glass w-4 h-4 text-googleGreen" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg> 
                                REFRESH
                            </div>
                            <div class="btn-add" onclick="addItem('usd')">
                                <svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg> 
                                NEW
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="pro-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div></div> <div>Symbol</div>
                            <div class="text-right">Qty</div>
                            <div class="text-right">Avg Cost</div>
                            <div class="text-right">Price</div>
                            <div class="text-right text-googleBlue">Market Value</div>
                            <div class="text-right">P/L</div>
                            <div class="text-right">Weight</div>
                            <div></div>
                        </div>
                        <div id="usd-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>

                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-2"><div class="w-1 h-4 bg-googleYellow rounded-full"></div><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">CNY</h2></div>
                        <div class="flex items-center gap-2">
                             <div class="btn-add text-googleGreen" onclick="updateCnStockPrices()">
                                <svg id="refresh-icon-cn" class="icon-glass w-4 h-4 text-googleGreen" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg> 
                                REFRESH
                            </div>
                            <div class="btn-add" onclick="addItem('cn')">
                                <svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> 
                                NEW
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="pro-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div></div> <div>Symbol</div>
                            <div class="text-right">Qty</div>
                            <div class="text-right">Avg Cost</div>
                            <div class="text-right">Price</div>
                            <div class="text-right text-googleYellow">Market Value</div>
                            <div class="text-right">P/L</div>
                            <div class="text-right">Weight</div>
                            <div></div>
                        </div>
                        <div id="cn-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>

                <div class="g-card-static overflow-hidden">
                    <div class="px-5 py-3 border-b border-borderSubtle dark:border-darkBorder bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-2"><div class="w-1 h-4 bg-googleGreen rounded-full"></div><h2 class="text-sm font-bold text-textPrimary dark:text-darkText uppercase tracking-wide">CASH</h2></div>
                        <div class="btn-add" onclick="addItem('cash')"><svg class="icon-glass w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>NEW</div>
                    </div>
                    <div class="bg-white dark:bg-darkSurface transition-colors">
                        <div class="cash-grid-header px-4 py-2 border-b border-borderSubtle dark:border-darkBorder text-[0.6rem] font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">
                            <div></div> <div>Category</div>
                            <div class="text-right">Amount</div>
                            <div class="text-right">Value</div>
                            <div class="text-right">Weight</div>
                            <div></div>
                        </div>
                        <div id="cash-inputs" class="divide-y divide-borderSubtle dark:divide-darkBorder"></div>
                    </div>
                </div>
            </div>

        </div> 
        
        <div class="g-card-static p-6 mt-3 w-full bg-white dark:bg-darkSurface transition-colors border-none shadow-sm">
            <div class="flex justify-between items-center mb-1.5">
                
                <div class="flex gap-1.5 bg-gray-100 dark:bg-darkBg p-1 rounded-lg">
                    <button id="tab-daily" onclick="switchView('daily')" class="px-6 py-2 text-sm font-bold rounded-md bg-white dark:bg-darkSurface shadow-sm text-textPrimary dark:text-darkText transition-all">Daily View</button>
                    <button id="tab-yearly" onclick="switchView('yearly')" class="px-6 py-2 text-sm font-bold rounded-md text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText transition-all">Yearly View</button>
                </div>
                
                <div id="controls-daily" class="flex gap-1 bg-gray-100 dark:bg-darkBg p-1 rounded-lg">
                    <button id="view-mode-0" onclick="setCalendarView(0)" class="px-4 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-darkSurface shadow-sm text-blue-600 dark:text-blue-400 transition-all">P/L</button>
                    <button id="view-mode-1" onclick="setCalendarView(1)" class="px-4 py-1.5 text-xs font-bold rounded-md text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText transition-all">Rate</button>
                    <button id="view-mode-2" onclick="setCalendarView(2)" class="px-4 py-1.5 text-xs font-bold rounded-md text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText transition-all">Total</button>
                </div>

                <div id="controls-yearly" class="hidden flex items-center gap-3">
                    <span class="px-3 py-1.5 text-xs font-bold bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full" id="current-year-badge">2026</span>
                </div>
            </div>
            
            <div id="view-daily" class="w-full">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <button onclick="changeMonth(-1)" class="p-1.5 text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText bg-gray-50 dark:bg-darkBg rounded-full transition-all focus:outline-none">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <div id="cal-month-display" class="text-base font-bold text-textPrimary dark:text-darkText w-32 text-center tracking-wide">...</div>
                    <button onclick="changeMonth(1)" class="p-1.5 text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText bg-gray-50 dark:bg-darkBg rounded-full transition-all focus:outline-none">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
               
                <div id="calendar-grid" class="grid grid-cols-7 gap-2.5 mt-4"></div>
            </div>

            <div id="view-yearly" class="hidden w-full">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <button onclick="changeYear(-1)" class="p-1.5 text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText bg-gray-50 dark:bg-darkBg rounded-full transition-all focus:outline-none">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <div id="cal-year-display" class="text-base font-bold text-textPrimary dark:text-darkText w-32 text-center tracking-wide">...</div>
                    <button onclick="changeYear(1)" class="p-1.5 text-textSecondary dark:text-darkTextSec hover:text-textPrimary dark:hover:text-darkText bg-gray-50 dark:bg-darkBg rounded-full transition-all focus:outline-none">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3 mb-6" id="monthly-grid"></div>
               <div class="flex flex-col justify-center items-center gap-1 pt-2">
    <span class="text-sm font-bold text-textSecondary dark:text-darkTextSec uppercase tracking-wider">YTD</span>
    <span id="yearly-total" class="text-3xl font-bold font-mono mt-1">--</span>
</div>
            </div>
        </div>
        </div>

    <div id="delete-popover" class="hidden absolute z-50 bg-white dark:bg-[#303134] shadow-lg border border-gray-200 dark:border-gray-600 rounded-lg p-2 opacity-0 transform scale-95 origin-top-right w-40">
        <p class="text-xs text-textPrimary dark:text-darkText font-medium text-center mb-2 p-1">Confirm Delete?</p>
        <div class="flex gap-2 justify-center">
            <button onclick="closePopover()" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 rounded text-textSecondary dark:text-darkTextSec">Cancel</button>
            <button id="popover-confirm-btn" class="px-2 py-1 text-xs bg-googleRed text-white rounded hover:bg-red-600 shadow-sm">Delete</button>
        </div>
    </div>

    <script>
        // ==============================================
        // 1. 初始化与数据管理
        function animateNumber(element, start, end, duration = 500, prefix = '', decimals = 2) {
            let startTime = null;
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const current = progress * (end - start) + start;
                element.innerText = prefix + current.toFixed(decimals);
                if (progress < 1) window.requestAnimationFrame(step);
            }
            window.requestAnimationFrame(step);
        }
// ==============================================
        // 系统设置面板与配置保存逻辑
        // ==============================================
        
        // 控制设置面板的展开与收起
        function toggleSyncPanel() {
            const panel = document.getElementById('sync-panel');
            if (panel.classList.contains('hidden-panel')) {
                // 面板展开时，自动从本地读取已保存的配置填充到输入框
                document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
                document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || '';
                document.getElementById('gh-path').value = localStorage.getItem('gh_path') || '';
                document.getElementById('finnhub-token').value = localStorage.getItem('finnhub_key') || '';
                panel.classList.remove('hidden-panel');
            } else {
                panel.classList.add('hidden-panel');
            }
        }

        // 保存配置并给予视觉反馈
        function saveSyncSettings() {
            const ghToken = document.getElementById('gh-token').value;
            const ghRepo = document.getElementById('gh-repo').value;
            const ghPath = document.getElementById('gh-path').value;
            const finnhubToken = document.getElementById('finnhub-token').value;

            // 保存到本地浏览器缓存
            localStorage.setItem('gh_token', ghToken);
            localStorage.setItem('gh_repo', ghRepo);
            localStorage.setItem('gh_path', ghPath);
            localStorage.setItem('finnhub_key', finnhubToken);

            // 动态按钮反馈效果
            const saveBtn = document.querySelector('button[onclick="saveSyncSettings()"]');
            const originalText = saveBtn.innerText;
            saveBtn.innerText = 'Saved ✓';
            saveBtn.classList.add('text-googleGreen', 'border-googleGreen');
            
            // 2秒后恢复原状
            setTimeout(() => {
                saveBtn.innerText = originalText;
                saveBtn.classList.remove('text-googleGreen', 'border-googleGreen');
            }, 2000);
        }
// ==============================================
        // 数据导出与导入逻辑
        // ==============================================
        
        // 导出本地数据为 JSON 文件
        function exportData() {
            try {
                // 将当前的 state 对象转为格式化的 JSON 字符串
                const dataStr = JSON.stringify(state, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                
                // 自动生成当天的日期作为文件名
                const dateSuffix = new Date().toISOString().slice(0,10);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `AssetHub_Backup_${dateSuffix}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error("Export failed:", err);
            }
        }

        // 读取导入的 JSON 文件并刷新页面数据
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (importedState && typeof importedState === 'object') {
                        state = importedState;
                        
                        // 兼容处理缺失的字段
                        if(!state.usd) state.usd = [];
                        if(!state.cn) state.cn = [];
                        if(!state.cash) state.cash = [];
                        if(!state.history) state.history = [];
                        
                        // 保存并全面重绘界面
                        saveData();
                        calculate();
                        renderAllRows();
                        initSortable();
                        
                        // 如果汇率有覆盖，更新输入框
                        if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate;
                        
                        // 按钮给出视觉反馈
                        const importBtn = input.previousElementSibling;
                        const origText = importBtn.innerHTML;
                        importBtn.innerHTML = 'Success ✓';
                        importBtn.classList.add('text-googleGreen', 'border-googleGreen');
                        
                        setTimeout(() => {
                            importBtn.innerHTML = origText;
                            importBtn.classList.remove('text-googleGreen', 'border-googleGreen');
                        }, 2000);
                    }
                } catch (err) {
                    alert('数据格式不正确，导入失败！');
                }
            };
            reader.readAsText(file);
            input.value = ''; // 清空 input 的值，以便下次可以重复导入同一个文件
        }
        // 顺便补齐备份数据到 GitHub 的逻辑 (如果之前丢失的话)
        async function pushToGithub() {
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');
            const path = localStorage.getItem('gh_path');
            if (!token || !repo) return alert('请先保存 GitHub 配置');

            const btn = document.querySelector('button[onclick="pushToGithub()"]');
            const origText = btn.innerText;
            btn.innerText = 'Pushing...';

            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            try {
                let sha = '';
                const getRes = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (getRes.ok) {
                    const data = await getRes.json();
                    sha = data.sha;
                }

                const content = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
                const body = { message: "Backup from AssetHub", content: content, sha: sha || undefined };

                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (putRes.ok) {
                    btn.innerText = 'Success ✓';
                    btn.classList.add('bg-googleGreen');
                } else {
                    btn.innerText = 'Failed ✕';
                    btn.classList.add('bg-googleRed');
                }
            } catch (e) { 
                btn.innerText = 'Error ✕';
            } finally {
                setTimeout(() => {
                    btn.innerText = origText;
                    btn.className = 'btn-action text-white bg-googleBlue border-transparent hover:bg-blue-600 shadow-sm';
                }, 2000);
            }
        }
        const defaultState = {
            usd: [{ id: '1', ticker: 'VOO', shares: 0, cost: 0, price: 0 }],
            cn: [{ id: '5', ticker: 'sh600036', shares: 0, cost: 0, price: 0 }],
            cash: [{ id: '7', ticker: 'USD', amount: 0, currency: 'USD' }],
            fxRate: 7,
            history: [] 
        };

        let savedState = localStorage.getItem('portfolioData');
        let state;
        try {
            state = savedState ? JSON.parse(savedState) : defaultState;
            if(!state.usd) state.usd = [];
            if(!state.cn) state.cn = [];
            if(!state.cash) state.cash = [];
            if(!state.history) state.history = []; 
        } catch(e) {
            state = defaultState;
        }

        if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate;

        let isPrivacyMode = localStorage.getItem('portfolio_privacy') === 'true';
        let charts = {};
        let itemToDelete = null;
        
        let displayDate = new Date();
        let calViewMode = 0; 

        function saveData() {
            state.fxRate = parseFloat(document.getElementById('fx-rate').value) || 7.25;
            localStorage.setItem('portfolioData', JSON.stringify(state));
        }

        // ==============================================
        // 2. 核心计算与历史记录
        function calculate() {
            const fx = parseFloat(document.getElementById('fx-rate').value) || 7.25;
            
            const usdItems = state.usd || [];
            const cnItems = state.cn || [];
            const cashItems = state.cash || [];
            
            const totalUsdStockVal = usdItems.reduce((a, i) => a + (i.shares * i.price), 0);
            const totalCnStockVal = cnItems.reduce((a, i) => a + (i.shares * i.price), 0);
            
            let totalUsdCashVal = 0, totalRmbCashVal = 0;
            cashItems.forEach(i => { 
                if(i.currency === 'USD') totalUsdCashVal += i.amount; 
                else totalRmbCashVal += i.amount; 
            });
            
            const totalCashValRmb = (totalUsdCashVal * fx) + totalRmbCashVal;
            const totalUsdAssets = totalUsdStockVal + totalUsdCashVal;
            const totalRmbAssets = totalCnStockVal + totalRmbCashVal;
            const grandTotal = (totalUsdAssets * fx) + totalRmbAssets;
            const cashRatio = grandTotal > 0 ? (totalCashValRmb / grandTotal) * 100 : 0;

            const totalUsdStockCost = usdItems.reduce((a, i) => a + (i.shares * (i.cost || 0)), 0);
            const totalCnStockCost = cnItems.reduce((a, i) => a + (i.shares * (i.cost || 0)), 0);
            const currentTotalCost = Math.round((totalUsdStockCost + totalUsdCashVal) * fx + totalCnStockCost + totalRmbCashVal);

            const localDate = new Date();
            const todayStr = `${localDate.getFullYear()}-${String(localDate.getMonth()+1).padStart(2,'0')}-${String(localDate.getDate()).padStart(2,'0')}`;
            const currentTotal = Math.round(grandTotal);

            const pastRecords = state.history.filter(h => h.date !== todayStr);
            let baseline = pastRecords.length > 0 ? pastRecords[pastRecords.length - 1] : null;

            if (!baseline) {
                if (!state.day1Baseline) state.day1Baseline = { total: currentTotal, cost: currentTotalCost };
                baseline = state.day1Baseline;
            } else {
                delete state.day1Baseline; 
            }

            if (baseline && baseline.cost === undefined) {
                baseline.cost = currentTotalCost;
            }

            let pl = 0, rate = 0, netFlow = 0;
            if (baseline) {
                const prevTotal = baseline.total || baseline.value || currentTotal;
                const prevCost = baseline.cost; 
                
                netFlow = currentTotalCost - prevCost;
                pl = currentTotal - prevTotal - netFlow; 
                rate = prevTotal > 0 ? (pl / prevTotal) * 100 : 0;
            }

            let todayRecord = state.history.find(h => h.date === todayStr);
            if (todayRecord) {
                todayRecord.total = currentTotal;
                todayRecord.cost = currentTotalCost;
                todayRecord.pl = pl;
                todayRecord.rate = rate;
                todayRecord.netFlow = netFlow;
                todayRecord.value = currentTotal;
            } else {
                state.history.push({ 
                    date: todayStr, total: currentTotal, cost: currentTotalCost, 
                    pl: pl, rate: rate, netFlow: netFlow, value: currentTotal 
                });
            }
            
            if (state.history.length > 365) state.history.shift();

            const totalNwEl = document.getElementById('total-nw-cny');
            if (totalNwEl) {
                if (isPrivacyMode) totalNwEl.innerText = '******';
                else animateNumber(totalNwEl, parseFloat(totalNwEl.innerText.replace(/[¥\s,]/g, '')) || 0, grandTotal, 500, '¥', 2);
            }

            const totalUsdEl = document.getElementById('total-usd-assets');
            if (totalUsdEl) {
                if (isPrivacyMode) totalUsdEl.innerText = '******';
                else animateNumber(totalUsdEl, parseFloat(totalUsdEl.innerText.replace(/[\$\s,]/g, '')) || 0, totalUsdAssets, 600, '$', 2);
            }

            const totalCnyEl = document.getElementById('total-cny-assets');
            if (totalCnyEl) {
                if (isPrivacyMode) totalCnyEl.innerText = '******';
                else animateNumber(totalCnyEl, parseFloat(totalCnyEl.innerText.replace(/[¥\s,]/g, '')) || 0, totalRmbAssets, 500, '¥', 2);
            }

            const re = document.getElementById('cash-ratio');
            if(re) {
                re.innerText = cashRatio.toFixed(1) + '%';
                re.className = `text-2xl font-bold font-mono ${cashRatio < 15 ? 'text-googleRed' : 'text-googleGreen'}`;
            }
            const bar = document.getElementById('cash-bar');
            if(bar) {
                bar.style.width = Math.min(cashRatio, 100) + '%';
                bar.className = `h-full rounded-full transition-all duration-500 ${cashRatio < 15 ? 'bg-googleRed' : 'bg-googleGreen'}`;
            }

            if(charts.main) updateChart(charts.main, [(totalUsdStockVal * fx), totalCnStockVal, totalCashValRmb]);

            const usLabels = usdItems.map(i => i.ticker);
            const usData = usdItems.map(i => i.shares * i.price);
            const cnLabels = cnItems.map(i => i.ticker);
            const cnData = cnItems.map(i => i.shares * i.price);
            const cashLabels = cashItems.map(i => i.ticker);
            const cashData = cashItems.map(i => i.currency === 'USD' ? i.amount * fx : i.amount);

            if(charts.usSub) {
                const colors = generateShades('#1a73e8', usData.length);
                updateSubChart(charts.usSub, usLabels, usData, colors);
                updateCustomLegend('legend-us', usLabels, colors);
            }
            if(charts.cnSub) {
                const colors = generateShades('#fbbc04', cnData.length);
                updateSubChart(charts.cnSub, cnLabels, cnData, colors);
                updateCustomLegend('legend-cn', cnLabels, colors);
            }
            if(charts.cashSub) { 
                 const colors = generateShades('#34a853', cashData.length);
                 updateSubChart(charts.cashSub, cashLabels, cashData, colors);
            }

            updateRowValues('usd', usdItems, totalUsdStockVal, '$');
            updateRowValues('cn', cnItems, totalCnStockVal, '¥');
            updateCashRowValues(totalCashValRmb, fx);

            saveData();
            renderCalendar(); 
            renderYearlySummary(); 
        }

        function updateRowValues(type, items, totalVal, symbol) {
            items.forEach(item => {
                const valEl = document.getElementById(`val-${type}-${item.id}`);
                const plEl = document.getElementById(`pl-${type}-${item.id}`);
                const allocEl = document.getElementById(`alloc-${type}-${item.id}`);
                
                if (!valEl) return;

                const val = item.shares * item.price;
                const costBasis = item.shares * item.cost;
                const pl = val - costBasis;
                const plPct = costBasis > 0 ? (pl / costBasis) * 100 : 0;
                const allocPct = totalVal > 0 ? (val / totalVal) * 100 : 0;
                
                let color = 'text-gray-400 dark:text-gray-500';
                if (pl > 0.01) color = 'text-googleGreen';
                if (pl < -0.01) color = 'text-googleRed';

                const sign = pl > 0 ? '+' : ''; 
				valEl.innerText = `${symbol}${val.toFixed(2)}`;
                
                if(plEl) {
                    plEl.className = `text-right font-mono font-medium ${color}`;
                    plEl.innerHTML = `${sign}${Math.round(pl)} / ${sign}${plPct.toFixed(2)}%`;
                }
                if(allocEl) allocEl.innerText = `${allocPct.toFixed(1)}%`;
            });
        }

        function updateCashRowValues(totalCashRmb, fx) {
            state.cash.forEach(item => {
                const valEl = document.getElementById(`val-cash-${item.id}`);
                const allocEl = document.getElementById(`alloc-cash-${item.id}`);
                if(!valEl) return;
                let rmbVal = item.currency === 'USD' ? item.amount * fx : item.amount;
                let allocPct = totalCashRmb > 0 ? (rmbVal / totalCashRmb) * 100 : 0;
                valEl.innerText = `¥${Math.round(rmbVal)}`;
                allocEl.innerText = `${allocPct.toFixed(1)}%`;
            });
        }

        // ==============================================
        // 3. 渲染模块 (表格 + 视图切换 + 复合日历)
        function renderAllRows() {
            renderRows('usd', state.usd, '$');
            renderRows('cn', state.cn, '¥');
            renderCashRows();
        }

        function renderRows(type, items, symbol) {
            const container = document.getElementById(type + '-inputs');
            if(!container) return; 
            container.innerHTML = items.map(item => {
                return `
                <div class="pro-grid-row px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b border-gray-50 dark:border-gray-800 last:border-0 text-sm">
                    <div class="drag-handle"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg></div>
                    <div><input type="text" class="input-google w-full font-bold text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="ticker" value="${item.ticker}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="shares" value="${item.shares}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textSecondary dark:text-darkTextSec" data-type="${type}" data-id="${item.id}" data-field="cost" value="${item.cost}"></div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText" data-type="${type}" data-id="${item.id}" data-field="price" value="${item.price}"></div>
                    <div class="text-right font-mono font-bold text-textPrimary dark:text-darkText" id="val-${type}-${item.id}">--</div>
                    <div class="text-right font-mono font-medium" id="pl-${type}-${item.id}">--</div>
                    <div class="text-right font-mono text-textSecondary dark:text-darkTextSec" id="alloc-${type}-${item.id}">--</div>
                    <div class="flex justify-center"><svg onclick="toggleDeletePopover(event, '${type}', '${item.id}')" class="delete-trigger icon-glass btn-icon w-4 h-4 text-gray-300 dark:text-gray-600 cursor-pointer hover:text-red-500 transition-colors" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
                </div>`;
            }).join('');
            container.querySelectorAll('input').forEach(i => i.addEventListener('input', e => handleInput(e.target)));
        }

        function renderCashRows() {
            const container = document.getElementById('cash-inputs');
            if(!container) return;
            container.innerHTML = state.cash.map(item => {
                return `
                <div class="cash-grid-row px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors border-b border-gray-50 dark:border-gray-800 last:border-0 text-sm">
                    <div class="drag-handle"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg></div>
                    <div class="flex items-center gap-1">
                        <select onchange="handleCurrencyChange('${item.id}', this.value)" class="bg-transparent text-xs border-none focus:ring-0 text-textSecondary dark:text-darkTextSec mr-1 cursor-pointer font-bold"><option value="USD" ${item.currency === 'USD'?'selected':''}>$</option><option value="CNY" ${item.currency === 'CNY'?'selected':''}>¥</option></select>
                        <input type="text" class="input-google w-full font-medium text-textPrimary dark:text-darkText" data-type="cash" data-id="${item.id}" data-field="ticker" value="${item.ticker}">
                    </div>
                    <div><input type="number" class="input-google w-full text-right font-mono text-textPrimary dark:text-darkText font-bold" data-type="cash" data-id="${item.id}" data-field="amount" value="${item.amount}"></div>
                    <div class="text-right font-mono font-medium text-textPrimary dark:text-darkText" id="val-cash-${item.id}">--</div>
                    <div class="text-right font-mono text-textSecondary dark:text-darkTextSec" id="alloc-cash-${item.id}">--</div>
                    <div class="flex justify-center"><svg onclick="toggleDeletePopover(event, 'cash', '${item.id}')" class="delete-trigger icon-glass btn-icon w-4 h-4 text-gray-300 dark:text-gray-600 cursor-pointer hover:text-red-500 transition-colors" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
                </div>`;
            }).join('');
            container.querySelectorAll('input').forEach(i => i.addEventListener('input', e => handleInput(e.target)));
        }

        // --- 视图切换相关 ---
        function switchView(view) {
            const tabDaily = document.getElementById('tab-daily');
            const tabYearly = document.getElementById('tab-yearly');
            const viewDaily = document.getElementById('view-daily');
            const viewYearly = document.getElementById('view-yearly');
            const controlsDaily = document.getElementById('controls-daily');
            const controlsYearly = document.getElementById('controls-yearly');

            const activeClasses = ['bg-white', 'dark:bg-darkSurface', 'shadow-sm', 'text-textPrimary', 'dark:text-darkText'];
            const inactiveClasses = ['text-textSecondary', 'dark:text-darkTextSec', 'hover:text-textPrimary', 'dark:hover:text-darkText'];

            if (view === 'daily') {
                tabDaily.classList.add(...activeClasses);
                tabDaily.classList.remove(...inactiveClasses);
                tabYearly.classList.add(...inactiveClasses);
                tabYearly.classList.remove(...activeClasses);
                
                viewDaily.classList.remove('hidden');
                controlsDaily.classList.remove('hidden');
                viewYearly.classList.add('hidden');
                controlsYearly.classList.add('hidden');
            } else {
                tabYearly.classList.add(...activeClasses);
                tabYearly.classList.remove(...inactiveClasses);
                tabDaily.classList.add(...inactiveClasses);
                tabDaily.classList.remove(...activeClasses);
                
                viewYearly.classList.remove('hidden');
                controlsYearly.classList.remove('hidden');
                viewDaily.classList.add('hidden');
                controlsDaily.classList.add('hidden');
            }
        }

        function setCalendarView(mode) {
            calViewMode = mode;
            const activeClasses = ['bg-white', 'dark:bg-darkSurface', 'shadow-sm', 'text-blue-600', 'dark:text-blue-400'];
            const inactiveClasses = ['text-textSecondary', 'dark:text-darkTextSec', 'hover:text-textPrimary', 'dark:hover:text-darkText'];

            for (let i = 0; i <= 2; i++) {
                const btn = document.getElementById(`view-mode-${i}`);
                if (i === mode) {
                    btn.classList.add(...activeClasses);
                    btn.classList.remove(...inactiveClasses);
                } else {
                    btn.classList.add(...inactiveClasses);
                    btn.classList.remove(...activeClasses);
                }
            }
            renderCalendar();
        }

        function jumpToMonth(monthIndex) {
            displayDate.setMonth(monthIndex);
            renderCalendar();
            renderYearlySummary();
            switchView('daily');
        }

        function renderYearlySummary() {
            const currentYear = displayDate.getFullYear();
            const yearBadge = document.getElementById('current-year-badge');
            if (yearBadge) yearBadge.innerText = currentYear;
            
            const yearDisplay = document.getElementById('cal-year-display');
            if (yearDisplay) yearDisplay.innerText = currentYear;

            const monthlyData = new Array(12).fill(0);
            let ytdTotal = 0;

            state.history.forEach(record => {
                if (!record.date) return;
                const parts = record.date.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; 

                if (year === currentYear) {
                    const pl = record.pl || 0;
                    monthlyData[month] += pl;
                    ytdTotal += pl;
                }
            });

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const grid = document.getElementById('monthly-grid');
            
            if (grid) {
                grid.innerHTML = monthlyData.map((val, index) => {
                    const isPos = val >= 0;
                    const valText = val === 0 ? '0.00' : (isPos ? '+' + val.toFixed(2) : val.toFixed(2));
                    
                    let colorClass = 'text-gray-400 dark:text-gray-500';
                    let bgClass = 'bg-gray-50 dark:bg-darkBg';
                    
                    if (val > 0) {
                        colorClass = 'text-stockGreen dark:text-green-300';
                        bgClass = 'bg-stockGreenBg dark:bg-green-900/20';
                    } else if (val < 0) {
                        colorClass = 'text-stockRed dark:text-red-300';
                        bgClass = 'bg-stockRedBg dark:bg-red-900/20';
                    }
                    
                    return `
                        <div onclick="jumpToMonth(${index})" class="py-6 px-3 min-h-[200px] rounded-lg ${bgClass} flex flex-col items-center justify-center cursor-pointer hover:-translate-y-1.5 transition-all duration-300">
                            <span class="text-sm font-bold text-gray-500 dark:text-darkTextSec uppercase mb-3">${monthNames[index]}</span>
                            <span class="text-2xl font-bold font-mono tracking-tight ${colorClass}">${valText}</span>
                        </div>
                    `;
                }).join('');
            }

            const totalEl = document.getElementById('yearly-total');
            if (totalEl) {
                const isPos = ytdTotal >= 0;
                totalEl.innerText = (isPos ? '+' : '') + ytdTotal.toFixed(2);
                
                if (ytdTotal > 0) {
                    totalEl.className = 'text-3xl font-bold font-mono tracking-tight text-stockGreen dark:text-green-300';
                } else if (ytdTotal < 0) {
                    totalEl.className = 'text-3xl font-bold font-mono tracking-tight text-stockRed dark:text-red-300';
                } else {
                    totalEl.className = 'text-3xl font-bold font-mono tracking-tight text-gray-400 dark:text-gray-500';
                }
            }
        }

        function renderCalendar() {
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            
            document.getElementById('cal-month-display').innerText = `${monthNames[month]} ${year}`;
            const grid = document.getElementById('calendar-grid');
            if(!grid) return;
            grid.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calData = {};
            state.history.forEach(item => {
                calData[item.date] = { 
                    total: item.total || item.value || 0, 
                    pl: item.pl || 0, 
                    rate: item.rate || 0,
                    netFlow: item.netFlow || 0  
                };
            });

            for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div></div>`; }

            const localDate = new Date();
            const todayStr = `${localDate.getFullYear()}-${String(localDate.getMonth()+1).padStart(2,'0')}-${String(localDate.getDate()).padStart(2,'0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const data = calData[dateStr];
                const isToday = (dateStr === todayStr);

                let bgClass = "bg-gray-50 dark:bg-darkBg";
                let textClass = "text-gray-400 dark:text-darkTextSec";
                let dayText = day;
                let valHtml = `<span class="text-sm text-transparent">0</span>`; 
                let flowHtml = ''; 

                if (data) {
                    const isPos = data.pl >= 0;
                    let displayVal = '';
                    
                    if (isPrivacyMode) {
                        displayVal = '***';
                        textClass = "text-gray-500 dark:text-darkTextSec";
                        bgClass = "bg-gray-100 dark:bg-[#3c4043]";
                    } else {
                        if (calViewMode === 0) {
                            displayVal = isPos ? `+${data.pl.toFixed(2)}` : `${data.pl.toFixed(2)}`;
                            textClass = isPos ? "text-stockGreen dark:text-green-300" : "text-stockRed dark:text-red-300";
                            bgClass = isPos ? "bg-stockGreenBg dark:bg-green-900/20" : "bg-stockRedBg dark:bg-red-900/20";
                        } else if (calViewMode === 1) {
                            displayVal = isPos ? `+${data.rate.toFixed(2)}%` : `${data.rate.toFixed(2)}%`;
                            textClass = isPos ? "text-stockGreen dark:text-green-300" : "text-stockRed dark:text-red-300";
                            bgClass = isPos ? "bg-stockGreenBg dark:bg-green-900/20" : "bg-stockRedBg dark:bg-red-900/20";
                        } else {
                            displayVal = `¥${Math.round(data.total).toLocaleString()}`;
                            textClass = "text-gray-900 dark:text-gray-100";
                            bgClass = isPos ? "bg-stockGreenBg dark:bg-green-900/20" : "bg-stockRedBg dark:bg-red-900/20";
                        }

                        if (data.netFlow && Math.abs(data.netFlow) > 5) {
                            let fv = Math.round(data.netFlow);
                            let sign = fv > 0 ? '+' : '-';
                            let fText = `${sign}${Math.abs(fv).toLocaleString()}`;
                           const fColor = 'text-yellow-400 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-800/50';
                              flowHtml = `<div class="absolute top-[6px] right-[6px] text-[0.55rem] md:text-xs font-bold ${fColor} px-1 py-0.5 rounded shadow-sm tracking-tight" title="Cash Flow">${fText}</div>`;
                        }
                    }
                    
                    valHtml = `<span class="text-sm md:text-base font-bold font-mono tracking-tight mt-1 ${textClass}">${displayVal}</span>`;
                } else if (isToday) {
                    bgClass = "bg-gray-50 dark:bg-darkBg";
                }

                grid.innerHTML += `
                    <div class="relative flex flex-col justify-center items-center py-4 min-h-[80px] rounded-lg w-full transition-all hover:brightness-95 cursor-default ${bgClass}">
                        ${flowHtml}
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-400">${dayText}</span>
                        ${valHtml}
                    </div>
                `;
            }
        }

        function changeMonth(offset) {
            displayDate.setMonth(displayDate.getMonth() + offset);
            renderCalendar();
            renderYearlySummary();
        }

        function changeYear(offset) {
            displayDate.setFullYear(displayDate.getFullYear() + offset);
            renderCalendar();
            renderYearlySummary();
        }

        // ==============================================
        // 4. API 请求与交互逻辑
        async function pullFromGithub() {
            const token = localStorage.getItem('gh_token');
            const repo = localStorage.getItem('gh_repo');
            const path = localStorage.getItem('gh_path');
            if (!token || !repo) return alert('请先保存 GitHub 配置');

            const url = `https://api.github.com/repos/${repo}/contents/${path}`;
            try {
                const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    state = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    if(state.fxRate) document.getElementById('fx-rate').value = state.fxRate;
                    saveData(); calculate(); renderAllRows(); initSortable();
                    alert('拉取成功！');
                } else alert('拉取失败');
            } catch (e) { alert('网络错误'); }
        }

        function updateCnStockPrices() {
            const icon = document.getElementById('refresh-icon-cn');
            if (icon) icon.classList.add('animate-spin');

            const rawSymbols = state.cn.map(item => item.ticker.toLowerCase()).filter(t => t && t !== 'new');
            if (rawSymbols.length === 0) {
                if (icon) icon.classList.remove('animate-spin');
                return; 
            }

            const script = document.createElement('script');
            script.src = `https://qt.gtimg.cn/q=${rawSymbols.join(',')}&t=${Date.now()}`;
            
            script.onload = function() {
                let updatedCount = 0;
                rawSymbols.forEach(symbol => {
                    const dataStr = window['v_' + symbol];
                    if (dataStr) {
                        const parts = dataStr.split('~');
                        const price = parseFloat(parts[3]); 
                        const stock = state.cn.find(i => i.ticker.toLowerCase() === symbol);
                        if (stock && price > 0) { stock.price = price; updatedCount++; }
                    }
                });

                if (updatedCount > 0) { saveData(); renderAllRows(); calculate(); }
                if (icon) icon.classList.remove('animate-spin');
                document.body.removeChild(script);
            };
            script.onerror = function() { 
                console.error('A股网络请求失败'); 
                if (icon) icon.classList.remove('animate-spin'); 
            };
            document.body.appendChild(script);
        }

        async function updateUsStockPrices() {
            const apiKey = localStorage.getItem('finnhub_key');
            if (!apiKey) return alert('请先在配置面板填写 Finnhub API Key');
            
            const icon = document.getElementById('refresh-icon');
            if(icon) icon.classList.add('animate-spin');
            let updatedCount = 0;

            for (let item of state.usd) {
                if (!item.ticker || item.ticker === 'New') continue;
                try {
                    const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${item.ticker}&token=${apiKey}`);
                    const data = await res.json();
                    if (data.c) { item.price = data.c; updatedCount++; }
                } catch (e) { console.error(`更新 ${item.ticker} 失败`, e); }
            }

            if (updatedCount > 0) { saveData(); renderAllRows(); calculate(); } 
            else alert('未更新数据，请检查 Key 或网络');
            if(icon) icon.classList.remove('animate-spin');
        }

        async function fetchLiveRate() {
            const icon = document.querySelector('svg[onclick="fetchLiveRate()"]');
            if(icon) icon.classList.add('animate-spin'); 
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                if (data.rates.CNY) {
                    document.getElementById('fx-rate').value = data.rates.CNY.toFixed(4); 
                    saveData(); calculate(); 
                }
            } catch (error) {} 
            finally { if(icon) icon.classList.remove('animate-spin'); }
        }

        // ==============================================
        // 5. 事件绑定与工具
        function addItem(type) {
            const id = Date.now().toString();
            if (type === 'usd') state.usd.push({ id, ticker: 'New', shares: 0, cost: 0, price: 0 });
            else if (type === 'cn') state.cn.push({ id, ticker: 'New', shares: 0, cost: 0, price: 0 });
            else if (type === 'cash') state.cash.push({ id, ticker: 'New', amount: 0, currency: 'CNY' });
            saveData(); renderAllRows(); calculate(); initSortable();
        }

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            localStorage.setItem('portfolio_privacy', isPrivacyMode);
            const openEye = document.getElementById('eye-open');
            const closedEye = document.getElementById('eye-closed');
            if (isPrivacyMode) { openEye.classList.add('hidden'); closedEye.classList.remove('hidden'); } 
            else { openEye.classList.remove('hidden'); closedEye.classList.add('hidden'); }
            
            if (!isPrivacyMode) {
                document.getElementById('total-nw-cny').innerText = '¥0';
                document.getElementById('total-usd-assets').innerText = '$0';
                document.getElementById('total-cny-assets').innerText = '¥0';
            }
            calculate(); 
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateChartTheme(isDark);
            setTimeout(loadTradingViewTicker, 50); 
            renderCalendar();
            renderYearlySummary();
        }

        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        function updateChartTheme(isDark) {
            const textColor = isDark ? '#e8eaed' : '#5f6368';
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = isDark ? '#3c4043' : '#e5e7eb';
            Object.values(charts).forEach(chart => {
                if(chart.options.plugins.tooltip) {
                    chart.options.plugins.tooltip.backgroundColor = isDark ? '#303134' : '#fff';
                    chart.options.plugins.tooltip.bodyColor = isDark ? '#e8eaed' : '#5f6368';
                    chart.options.plugins.tooltip.borderColor = isDark ? '#5f6368' : '#dadce0';
                }
                chart.update();
            });
        }

        function toggleDeletePopover(event, type, id) {
            event.stopPropagation();
            const popover = document.getElementById('delete-popover');
            if(itemToDelete && itemToDelete.id === id && !popover.classList.contains('hidden')) return closePopover();
            itemToDelete = { type, id };
            const rect = event.currentTarget.getBoundingClientRect();
            popover.style.top = (window.scrollY + rect.top + 5) + 'px'; 
            popover.style.left = (window.scrollX + rect.left - 130) + 'px'; 
            popover.classList.remove('hidden');
            requestAnimationFrame(() => { popover.classList.remove('opacity-0', 'scale-95'); popover.classList.add('opacity-100', 'scale-100'); });
        }

        function closePopover() {
            const popover = document.getElementById('delete-popover');
            popover.classList.remove('opacity-100', 'scale-100');
            popover.classList.add('opacity-0', 'scale-95');
            setTimeout(() => { popover.classList.add('hidden'); itemToDelete = null; }, 100);
        }

        function handleBodyClick(event) {
            if (!document.getElementById('delete-popover').contains(event.target) && !event.target.closest('.delete-trigger')) closePopover();
        }

        document.getElementById('popover-confirm-btn').addEventListener('click', () => {
            if (itemToDelete) {
                state[itemToDelete.type] = state[itemToDelete.type].filter(i => i.id !== itemToDelete.id);
                if(itemToDelete.type==='cash') renderCashRows(); else renderRows(itemToDelete.type, state[itemToDelete.type], itemToDelete.type==='usd'?'$':'¥');
                calculate(); closePopover();
            }
        });

        function handleInput(t) { 
            if(t.id==='fx-rate'){calculate();return;} 
            const val = t.type==='number' ? parseFloat(t.value)||0 : t.value; 
            const item=state[t.dataset.type].find(x=>x.id===t.dataset.id); 
            if(item){ 
                if(t.dataset.type==='cash'&&t.dataset.field==='amount') item.amount=val; 
                else item[t.dataset.field]=val; 
                calculate(); 
            } 
        }

        function handleCurrencyChange(id, v) { const i=state.cash.find(x=>x.id===id); if(i){ i.currency=v; calculate(); } }

        // ==============================================
        // 6. 图表初始化
        function initCharts() {
            Chart.defaults.font.family = '"Google Sans", "Roboto", sans-serif';
            const tooltipCallback = { 
                label: function(ctx) { 
                    const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); 
                    const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) + '%' : '0%'; 
                    return ` ${ctx.label || ''}: ${ctx.raw.toFixed(2)} (${pct})`; 
                } 
            };
            
            const opts = (cutout) => ({ responsive: true, maintainAspectRatio: false, borderWidth: 0, cutout: cutout, layout: { padding: 0 }, plugins: { legend: { display: false }, tooltip: { enabled: true, borderWidth: 1, callbacks: tooltipCallback } } });
            
            const segPlugin = {
                id: 'segmentLabels',
                afterDatasetsDraw(chart) {
                    const { ctx, data } = chart;
                    ctx.save();
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    chart.getDatasetMeta(0).data.forEach((dp, i) => {
                        const pct = total > 0 ? (data.datasets[0].data[i] / total * 100) : 0;
                        if (pct > 5) { 
                            const { x, y } = dp.tooltipPosition();
                            ctx.font = '18px "Roboto Mono"'; ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                            ctx.fillText(pct.toFixed(0) + '%', x, y);
                        }
                    });
                    ctx.restore();
                }
            };

            const cm = document.getElementById('chart-main');
            if(cm) charts.main = new Chart(cm.getContext('2d'), { type: 'doughnut', data: { labels: ['US Stocks', 'CN Stocks', 'Cash'], datasets: [{ data: [1,1,1], backgroundColor: ['#1a73e8', '#fbbc04', '#34a853'], hoverOffset: 4 }] }, options: opts('55%'), plugins: [segPlugin] });
            const cu = document.getElementById('chart-us-sub');
            if(cu) charts.usSub = new Chart(cu.getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
            const cc = document.getElementById('chart-cn-sub');
            if(cc) charts.cnSub = new Chart(cc.getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
            const ca = document.getElementById('chart-cash-sub');
            if(ca) charts.cashSub = new Chart(ca.getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [], backgroundColor: [] }] }, options: opts('70%') });
        }

        function updateChart(c, d) { if(c) { c.data.datasets[0].data = d; c.update(); } }
        function updateSubChart(c, l, d, co) { if(c) { c.data.labels = l; c.data.datasets[0].data = d; c.data.datasets[0].backgroundColor = co; c.update(); } }
        
        function generateShades(baseHex, count) {
            const p = { 'blue': ['#1a73e8','#4285f4','#669df6','#8ab4f8','#aecbfa','#d2e3fc'], 'yellow': ['#f9ab00','#fbbc04','#fcd965','#fdd663','#fde293','#feefc3'], 'green': ['#188038','#34a853','#5bb974','#81c995','#a8dab5','#ceead6'] };
            let k = 'blue'; if(baseHex.includes('fbbc04')) k='yellow'; if(baseHex.includes('34a853')) k='green';
            let c=[]; for(let i=0; i<count; i++) c.push(p[k][i%p[k].length]); return c;
        }

        function updateCustomLegend(id, labels, colors) {
            const c = document.getElementById(id); if(!c) return;
            let h = ''; labels.forEach((l,i)=>{ h+=`<div class="flex items-center gap-3"><span class="w-1.5 h-1.5 rounded-full flex-shrink-0" style="background-color:${colors[i]}"></span><span class="text-xs font-bold text-gray-900 dark:text-gray-100 truncate tracking-tight">${l}</span></div>`; });
            c.innerHTML = h;
        }

        function initSortable() {
            ['usd-inputs', 'cn-inputs', 'cash-inputs'].forEach(id => {
                const el = document.getElementById(id);
                if (el) Sortable.create(el, { handle: '.drag-handle', animation: 150, ghostClass: 'bg-blue-50', onEnd: (evt) => {
                    const list = state[id.split('-')[0]];
                    const item = list.splice(evt.oldIndex, 1)[0];
                    list.splice(evt.newIndex, 0, item);
                    saveData(); calculate();
                }});
            });
        }

        // ==========================================
        // 7. TradingView Widget
        function loadTradingViewTicker() {
            const container = document.getElementById('tv-ticker-container');
            if (!container) return;
            container.innerHTML = ''; 
            const widgetDiv = document.createElement('div');
            widgetDiv.className = 'tradingview-widget-container__widget';
            container.appendChild(widgetDiv);

            const isDark = document.documentElement.classList.contains('dark');
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "symbols": [ { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" }, { "proName": "FOREXCOM:NSXUSD", "title": "US 100" }, { "proName": "FX_IDC:USDCNY", "title": "USD/CNY" }, { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" }, { "description": "Gold", "proName": "TVC:GOLD" } ],
                "showSymbolLogo": true, "colorTheme": isDark ? "dark" : "light", "isTransparent": false, "displayMode": "adaptive", "locale": "en"
            });
            container.appendChild(script);
        }

        // ==========================================
        // 8. 滚动入场动画初始化
        function initScrollReveal() {
            document.querySelectorAll('.g-card-static').forEach(card => {
                card.classList.add('reveal-card');
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                        observer.unobserve(entry.target);
                    }
                });
            }, { 
                threshold: 0.1, 
                rootMargin: "0px 0px -50px 0px" 
            });

            document.querySelectorAll('.reveal-card').forEach(el => observer.observe(el));
        }

        // ==========================================
        // 9. 开启丝滑惯性滚动 (Lenis)
        const lenis = new Lenis({
            duration: 1.2, 
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), 
            smooth: true
        });

        function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);

        // ==========================================
        // 10. 智能静默自动刷新机制 (10分钟冷却)
        function autoRefreshPrices() {
            const lastRefresh = localStorage.getItem('last_auto_refresh');
            const now = Date.now();
            const cooldown = 10 * 60 * 1000; 
            if (!lastRefresh || (now - parseInt(lastRefresh)) > cooldown) {
                console.log("冷却完毕，后台静默拉取最新资产价格");
                updateCnStockPrices();
                fetchLiveRate();
                if (localStorage.getItem('finnhub_key')) {
                    updateUsStockPrices();
                }
                localStorage.setItem('last_auto_refresh', now.toString());
            }
        }

        // ==========================================
        // 11. 页面加载初始化
        window.onload = function() { 
            if (isPrivacyMode) {
                document.getElementById('eye-open').classList.add('hidden');
                document.getElementById('eye-closed').classList.remove('hidden');
            }
            initCharts(); 
            loadTheme(); 
            renderAllRows(); 
            calculate(); 
            initSortable(); 
            document.getElementById('fx-rate').addEventListener('input', calculate);
            loadTradingViewTicker();
            initScrollReveal(); 
            autoRefreshPrices();
        };

    </script>
    <script type="module" src="https://widgets.tradingview-widget.com/w/en/tv-ticker-tape.js"></script>
    <div id="tv-ticker-container" class="fixed bottom-0 left-0 w-full z-50 transition-opacity duration-500" style="height: 46px;"></div>
</body>
</html>
